<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web VR | 糖衣月餅</title>
  <script src="main.bundle.js"></script>
  <script src="index.bundle.js"></script>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Top Page</a></li>
        <li><a href="products.html">Products</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>
      <span>Web VR</span>
    </h1>

    <section>
      <p>
        3Dエンジンを作りたかったのでせっかくなのでスマホのセンサと組み合わせてVRを作ろうというやつです。
        昔から3Dの視覚に興味があって、Scratchで3Dエンジンを作ったりしてました。
        大学でちゃんとCGを学んだのでそれを使って3Dエンジンをフルスクラッチで書いてます。
        ただ単純に授業で学んだ斜交座標のワールド座標系からカメラ座標系への変換だけではだめで、
        ワイヤーフレームモデルの描画だけでもカバーしないといけないエッジケースが多いなと思いました。
        昔作ったエンジンは無限遠点が存在しないから焦点距離使った比例計算だけで良かったんだけですけどね。
      </p>
    </section>
    <section>
      <h2>2021/12/31</h2>

      <p>
        ここから日記みたいな感じです。
        とりあえず現状は、描画はそれなりに動いている状態。
        ただカメラのZ軸(奥行き)周りの回転がうまく行かなくて平行四辺形に変形されてしまうので
        回転の演算がどこかおかしいんですよね。でもおかしいところがわからない。
        次に解決すべき課題はこれです。
        ただ顕在化しているのはz軸回りだけで、真横の物体がうまく見えないことから
        他の軸でもこれが起きてるんじゃないかなと薄々気づいてはいる.....
      </p>
      <p>
        前は無限に長い直線の描画に苦労していて、ワールド原点を通る線をうまく描画できていない状態だった。
        手前側に無限に伸びる半直線の描画がうまくできないので考えたら、
        可視領域と不可視領域の境界で一度スクリーン座標が発散することに気づいたので、
        カメラ座標系での平面z=0がその境界だからz=0との交点との間の線分を描画すればいいとなった。
        ので可視領域と不可視領域にまたがる線分(半直線でもいい)はz=0との交点をとって描画することにした。
        するとカメラに平行な直線が描画できなくて、それはz=0との交点が求められないから当然なんだけど、
        真逆の無限遠点を結ぶ直線を考えるとカメラ座標に変換する前に交点を求めなければいけない
        (無限遠点は並進しても変化しないので)ので面倒だと考えていたら、
        無限遠点から無限遠点への直線はVPの1点になると気づいたので、
        そういうことにして半直線だけを考えることにした。
        カメラ座標系で[1, 0, 0, 0]^Tに合同な座標とユークリッド空間に含まれる点の間の直線はz=0に並行なので、
        それだけ特例にしてスクリーン座標の左右に発散させるようにしたらうまく描画できた。
      </p>
    </section>

    <section>
      <h2>2022/1/5</h2>

      <p>
        回転がおかしいなって色んな所を見ていたら、やはり回転の計算がおかしかった。
        回転行列をかける演算で回転前の値を途中で更新してしまったせいで後続の計算が
        変更された値をもとに計算してしまっていた(a += 1; b += aみたいな)...
        なので回転行列を一気にかければいいのでどうせなので3軸の回転行列をかけ合わせたもの(の逆行列)
        を生成しておいてかけることにした。
      </p>
      <p>
        あとデバイスの姿勢を取得する部分だけ書いた。
        ただデバイスの3軸に対する回転を取得する(一応絶対を取得するのもあるけど標準じゃないっぽい？)ので
        ワールド座標軸の周りの回転への変換を考えなくてはいけない...頭が爆発する
      </p>
    </section>

    <section>
      <h2>2022/1/6</h2>

      <p>
        オイラー角を回転行列に変換するのがうまくいかない？
        なんかうまく解釈できていない気がする。
      </p>
    </section>

    <section>
      <h2>2022/1/7</h2>

      <p>
        なんとか変換をうまくやることができた。
        ただdevice orientationのオイラー角の基準点の関係でデバイスを
        平面においたときが水平になっているのでそこの補正をしないといけない...
      </p>
    </section>
  </main>
</body>
</html>